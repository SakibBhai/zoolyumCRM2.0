(()=>{var e={};e.id=1860,e.ids=[1860],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},11723:e=>{"use strict";e.exports=require("querystring")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},57659:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>I,routeModule:()=>v,serverHooks:()=>R,workAsyncStorage:()=>D,workUnitAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{DELETE:()=>j,GET:()=>w,PUT:()=>x});var a=r(44932),i=r(41913),o=r(96656),n=r(77949),u=r(86745),l=r(26718),p=r(96330),d=r(84133),c=r(8201);let m=new p.PrismaClient,E=d.Ik({title:d.Yj().min(1,"Title is required").optional(),description:d.Yj().optional(),status:d.k5(["DRAFT","SENT","VIEWED","ACCEPTED","REJECTED","EXPIRED"]).optional(),validUntil:d.Yj().datetime().optional(),items:d.YO(d.Ik({description:d.Yj().min(1,"Item description is required"),quantity:d.ai().min(0,"Quantity must be positive"),unitPrice:d.ai().min(0,"Unit price must be positive"),total:d.ai().min(0,"Total must be positive")})).optional(),subtotal:d.ai().min(0,"Subtotal must be positive").optional(),taxRate:d.ai().min(0).max(1,"Tax rate must be between 0 and 1").optional(),taxAmount:d.ai().min(0,"Tax amount must be positive").optional(),discountRate:d.ai().min(0).max(1,"Discount rate must be between 0 and 1").optional(),discountAmount:d.ai().min(0,"Discount amount must be positive").optional(),total:d.ai().min(0,"Total must be positive").optional(),notes:d.Yj().optional(),terms:d.Yj().optional()});async function w(e,{params:t}){try{let e=await (0,u.getServerSession)(l.Nh);if(!e?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{id:r}=await t;if(!r)return n.NextResponse.json({error:"Proposal ID is required"},{status:400});let s=await m.proposal.findUnique({where:{id:r},include:{client:{select:{id:!0,name:!0,email:!0,company:!0,phone:!0,address:!0}},project:{select:{id:!0,name:!0,description:!0,status:!0,priority:!0,startDate:!0,endDate:!0,budget:!0}},creator:{select:{id:!0,name:!0,email:!0}}}});if(!s)return n.NextResponse.json({error:"Proposal not found"},{status:404});return"SENT"===s.status&&e.user.id!==s.createdBy&&(await m.proposal.update({where:{id:r},data:{status:"VIEWED"}}),s.status="VIEWED"),n.NextResponse.json(s)}catch(e){return console.error("Error fetching proposal:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function x(e,{params:t}){try{let r=await (0,u.getServerSession)(l.Nh);if(!r?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{id:s}=await t;if(!s)return n.NextResponse.json({error:"Proposal ID is required"},{status:400});let a=await e.json(),i=E.parse(a),o=await m.proposal.findUnique({where:{id:s},select:{id:!0,status:!0,createdBy:!0,clientId:!0,projectId:!0}});if(!o)return n.NextResponse.json({error:"Proposal not found"},{status:404});let p=await m.user.findUnique({where:{id:r.user.id},select:{role:!0}});if(o.createdBy!==r.user.id&&p?.role!=="ADMIN")return n.NextResponse.json({error:"Insufficient permissions"},{status:403});if(("ACCEPTED"===o.status||"REJECTED"===o.status)&&"EXPIRED"!==i.status)return n.NextResponse.json({error:"Cannot modify accepted or rejected proposals"},{status:409});if(i.status){let e={DRAFT:["SENT","EXPIRED"],SENT:["VIEWED","ACCEPTED","REJECTED","EXPIRED"],VIEWED:["ACCEPTED","REJECTED","EXPIRED"],ACCEPTED:["EXPIRED"],REJECTED:["EXPIRED"],EXPIRED:[]}[o.status]||[];if(!e.includes(i.status))return n.NextResponse.json({error:`Invalid status transition from ${o.status} to ${i.status}`,allowedStatuses:e},{status:400})}let d={...i,updatedAt:new Date};i.validUntil&&(d.validUntil=new Date(i.validUntil));let c=await m.proposal.update({where:{id:s},data:d,include:{client:{select:{id:!0,name:!0,email:!0,company:!0,phone:!0}},project:{select:{id:!0,name:!0,status:!0}},creator:{select:{id:!0,name:!0,email:!0}}}});if("ACCEPTED"===i.status&&!o.projectId&&a.createProject){let e=await m.project.create({data:{name:c.title,description:c.content||"",clientId:o.clientId,managerId:r.user.id,status:"PLANNING",priority:"MEDIUM",budget:c.totalAmount,startDate:new Date,endDate:new Date(Date.now()+2592e6)}});return await m.proposal.update({where:{id:s},data:{projectId:e.id}}),n.NextResponse.json({...c,project:{id:e.id,name:e.name,status:e.status}})}return n.NextResponse.json(c)}catch(e){if(e instanceof c.G)return n.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error updating proposal:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function j(e,{params:t}){try{let e=await (0,u.getServerSession)(l.Nh);if(!e?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{id:r}=await t;if(!r)return n.NextResponse.json({error:"Proposal ID is required"},{status:400});let s=await m.proposal.findUnique({where:{id:r},select:{id:!0,status:!0,createdBy:!0,title:!0,projectId:!0}});if(!s)return n.NextResponse.json({error:"Proposal not found"},{status:404});let a=await m.user.findUnique({where:{id:e.user.id},select:{role:!0}});if(s.createdBy!==e.user.id&&a?.role!=="ADMIN")return n.NextResponse.json({error:"Insufficient permissions"},{status:403});if("ACCEPTED"===s.status)return n.NextResponse.json({error:"Cannot delete accepted proposals"},{status:409});if(s.projectId){let e=await m.project.findUnique({where:{id:s.projectId},select:{id:!0,status:!0,_count:{select:{tasks:!0}}}});if(e&&("CANCELLED"!==e.status||e._count.tasks>0))return n.NextResponse.json({error:"Cannot delete proposal linked to active project with tasks",projectId:e.id,projectStatus:e.status,taskCount:e._count.tasks},{status:409})}let i=await m.proposal.delete({where:{id:r},select:{id:!0,title:!0,status:!0}});return n.NextResponse.json({message:"Proposal deleted successfully",proposal:i})}catch(e){return console.error("Error deleting proposal:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let v=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/proposals/[id]/route",pathname:"/api/proposals/[id]",filename:"route",bundlePath:"app/api/proposals/[id]/route"},resolvedPagePath:"E:\\trae\\izoolyumCRM2.0\\zoolyumCRM2.0\\src\\app\\api\\proposals\\[id]\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:D,workUnitAsyncStorage:f,serverHooks:R}=v;function I(){return(0,o.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:f})}},27771:()=>{},87859:()=>{},26718:(e,t,r)=>{"use strict";r.d(t,{Nh:()=>p});var s=r(47033),a=r(58196),i=r(34875),o=r(65972),n=r(50826),u=r(96330);let l="true"===process.env.AUTH_BYPASS_ENABLED,p={adapter:(0,s.y)(o.z),session:{strategy:"jwt"},pages:{signIn:"/auth/signin",signUp:"/auth/signup"},providers:[(0,i.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,a.A)({name:"credentials",credentials:{email:{label:"Email",type:"email",placeholder:"john@example.com"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;if(l){console.warn("\uD83D\uDEA8 AUTH BYPASS MODE ENABLED - DEVELOPMENT ONLY!");let e=await o.z.user.findFirst({where:{role:u.UserRole.ADMIN,isActive:!0},select:{id:!0,email:!0,name:!0,role:!0,avatar:!0}});return e?{id:e.id,email:e.email,name:e.name,role:e.role,avatar:e.avatar}:{id:"bypass-user",email:"bypass@agency.com",name:"Bypass User (DEV)",role:u.UserRole.ADMIN,avatar:null}}let t=await o.z.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,password:!0,role:!0,avatar:!0,isActive:!0}});return t&&t.isActive&&t.password&&await (0,n.compare)(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role,avatar:t.avatar}:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role,e.avatar=t.avatar),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role,e.user.avatar=t.avatar),e),async signIn({user:e,account:t,profile:r}){if(t?.provider==="google")try{await o.z.user.findUnique({where:{email:e.email}})||await o.z.user.create({data:{email:e.email,name:e.name,avatar:e.image,role:u.UserRole.AGENT}})}catch(e){return console.error("Error creating user:",e),!1}return!0}}}},65972:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var s=r(96330);let a=globalThis.prisma??new s.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[5363,3186,7304,4133],()=>r(57659));module.exports=s})();