(()=>{var e={};e.id=5051,e.ids=[5051],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},11723:e=>{"use strict";e.exports=require("querystring")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},13414:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>A,routeModule:()=>f,serverHooks:()=>R,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{DELETE:()=>E,GET:()=>j,POST:()=>w,PUT:()=>g});var a=r(44932),i=r(41913),o=r(96656),n=r(77949),l=r(86745),u=r(26718),p=r(96330),d=r(84133),c=r(8201);let m=new p.PrismaClient,v=d.Ik({title:d.Yj().min(1,"Title is required"),description:d.Yj().optional(),clientId:d.Yj().min(1,"Client ID is required"),projectId:d.Yj().optional(),status:d.k5(["DRAFT","SENT","VIEWED","ACCEPTED","REJECTED","EXPIRED"]).default("DRAFT"),validUntil:d.Yj().datetime().optional(),items:d.YO(d.Ik({description:d.Yj().min(1,"Item description is required"),quantity:d.ai().min(0,"Quantity must be positive"),unitPrice:d.ai().min(0,"Unit price must be positive"),totalAmount:d.ai().min(0,"Total must be positive")})).min(1,"At least one item is required"),subtotal:d.ai().min(0,"Subtotal must be positive"),taxRate:d.ai().min(0).max(1,"Tax rate must be between 0 and 1").default(0),taxAmount:d.ai().min(0,"Tax amount must be positive").default(0),discountRate:d.ai().min(0).max(1,"Discount rate must be between 0 and 1").default(0),discountAmount:d.ai().min(0,"Discount amount must be positive").default(0),totalAmount:d.ai().min(0,"Total must be positive"),notes:d.Yj().optional(),terms:d.Yj().optional()}),x=d.Ik({title:d.Yj().min(1,"Title is required").optional(),description:d.Yj().optional(),status:d.k5(["DRAFT","SENT","VIEWED","ACCEPTED","REJECTED","EXPIRED"]).optional(),validUntil:d.Yj().datetime().optional(),items:d.YO(d.Ik({description:d.Yj().min(1,"Item description is required"),quantity:d.ai().min(0,"Quantity must be positive"),unitPrice:d.ai().min(0,"Unit price must be positive"),totalAmount:d.ai().min(0,"Total must be positive")})).optional(),subtotal:d.ai().min(0,"Subtotal must be positive").optional(),taxRate:d.ai().min(0).max(1,"Tax rate must be between 0 and 1").optional(),taxAmount:d.ai().min(0,"Tax amount must be positive").optional(),discountRate:d.ai().min(0).max(1,"Discount rate must be between 0 and 1").optional(),discountAmount:d.ai().min(0,"Discount amount must be positive").optional(),totalAmount:d.ai().min(0,"Total must be positive").optional(),notes:d.Yj().optional(),terms:d.Yj().optional()});async function j(e){try{let t=await (0,l.getServerSession)(u.Nh);if(!t?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),s=parseInt(r.get("page")||"1"),a=parseInt(r.get("limit")||"10"),i=r.get("search")||"",o=r.get("status"),p=r.get("clientId"),d=r.get("projectId"),c=r.get("dateFrom"),v=r.get("dateTo"),x=r.get("sortBy")||"createdAt",j=r.get("sortOrder")||"desc",w=(s-1)*a,g={};i&&(g.OR=[{title:{contains:i,mode:"insensitive"}},{description:{contains:i,mode:"insensitive"}},{notes:{contains:i,mode:"insensitive"}},{client:{name:{contains:i,mode:"insensitive"}}},{client:{company:{contains:i,mode:"insensitive"}}}]),o&&(g.status=o),p&&(g.clientId=p),d&&(g.projectId=d),(c||v)&&(g.createdAt={},c&&(g.createdAt.gte=new Date(c)),v&&(g.createdAt.lte=new Date(v)));let[E,f]=await Promise.all([m.proposal.findMany({where:g,skip:w,take:a,orderBy:{[x]:j},include:{client:{select:{id:!0,name:!0,email:!0,company:!0,phone:!0}},project:{select:{id:!0,name:!0,status:!0}},creator:{select:{id:!0,name:!0,email:!0}}}}),m.proposal.count({where:g})]),y=Math.ceil(f/a);return n.NextResponse.json({proposals:E,pagination:{page:s,limit:a,total:f,totalPages:y,hasNext:s<y,hasPrev:s>1}})}catch(e){return console.error("Error fetching proposals:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function w(e){try{let t=await (0,l.getServerSession)(u.Nh);if(!t?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json(),s=v.parse(r);if(!await m.client.findUnique({where:{id:s.clientId}}))return n.NextResponse.json({error:"Client not found"},{status:404});if(s.projectId){let e=await m.project.findUnique({where:{id:s.projectId}});if(!e)return n.NextResponse.json({error:"Project not found"},{status:404});if(e.clientId!==s.clientId)return n.NextResponse.json({error:"Project does not belong to the specified client"},{status:400})}let a=await m.proposal.count();String(a+1).padStart(4,"0");let i=await m.proposal.create({data:{...s,validUntil:s.validUntil?new Date(s.validUntil):void 0,createdBy:t.user.id},include:{client:{select:{id:!0,name:!0,email:!0,company:!0,phone:!0}},project:{select:{id:!0,name:!0,status:!0}},creator:{select:{id:!0,name:!0,email:!0}}}});return n.NextResponse.json(i,{status:201})}catch(e){if(e instanceof c.G)return n.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error creating proposal:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function g(e){try{let t=await (0,l.getServerSession)(u.Nh);if(!t?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{ids:r,data:s}=await e.json();if(!Array.isArray(r)||0===r.length)return n.NextResponse.json({error:"Proposal IDs array is required"},{status:400});let a=x.parse(s),i=await m.proposal.findMany({where:{id:{in:r}},select:{id:!0,status:!0,createdBy:!0}});if(i.length!==r.length)return n.NextResponse.json({error:"One or more proposals not found"},{status:404});let o=i.filter(e=>"ACCEPTED"===e.status||"REJECTED"===e.status);if(o.length>0&&"EXPIRED"!==a.status)return n.NextResponse.json({error:"Cannot modify accepted or rejected proposals",immutableProposals:o.map(e=>e.id)},{status:409});let p={...a,updatedAt:new Date};a.validUntil&&(p.validUntil=new Date(a.validUntil));let d=await m.proposal.updateMany({where:{id:{in:r}},data:p});return n.NextResponse.json({message:`${d.count} proposals updated successfully`,updatedCount:d.count})}catch(e){if(e instanceof c.G)return n.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error bulk updating proposals:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function E(e){try{let t=await (0,l.getServerSession)(u.Nh);if(!t?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{ids:r}=await e.json();if(!Array.isArray(r)||0===r.length)return n.NextResponse.json({error:"Proposal IDs array is required"},{status:400});let s=await m.proposal.findMany({where:{id:{in:r}},select:{id:!0,status:!0,title:!0}});if(s.length!==r.length)return n.NextResponse.json({error:"One or more proposals not found"},{status:404});let a=s.filter(e=>"ACCEPTED"===e.status);if(a.length>0)return n.NextResponse.json({error:"Cannot delete accepted proposals",acceptedProposals:a.map(e=>({id:e.id,title:e.title}))},{status:409});let i=await m.proposal.deleteMany({where:{id:{in:r}}});return n.NextResponse.json({message:`${i.count} proposals deleted successfully`,deletedCount:i.count})}catch(e){return console.error("Error deleting proposals:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/proposals/route",pathname:"/api/proposals",filename:"route",bundlePath:"app/api/proposals/route"},resolvedPagePath:"E:\\trae\\izoolyumCRM2.0\\zoolyumCRM2.0\\src\\app\\api\\proposals\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:h,serverHooks:R}=f;function A(){return(0,o.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:h})}},27771:()=>{},87859:()=>{},26718:(e,t,r)=>{"use strict";r.d(t,{Nh:()=>p});var s=r(47033),a=r(58196),i=r(34875),o=r(65972),n=r(50826),l=r(96330);let u="true"===process.env.AUTH_BYPASS_ENABLED,p={adapter:(0,s.y)(o.z),session:{strategy:"jwt"},pages:{signIn:"/auth/signin",signUp:"/auth/signup"},providers:[(0,i.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,a.A)({name:"credentials",credentials:{email:{label:"Email",type:"email",placeholder:"john@example.com"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;if(u){console.warn("\uD83D\uDEA8 AUTH BYPASS MODE ENABLED - DEVELOPMENT ONLY!");let e=await o.z.user.findFirst({where:{role:l.UserRole.ADMIN,isActive:!0},select:{id:!0,email:!0,name:!0,role:!0,avatar:!0}});return e?{id:e.id,email:e.email,name:e.name,role:e.role,avatar:e.avatar}:{id:"bypass-user",email:"bypass@agency.com",name:"Bypass User (DEV)",role:l.UserRole.ADMIN,avatar:null}}let t=await o.z.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,password:!0,role:!0,avatar:!0,isActive:!0}});return t&&t.isActive&&t.password&&await (0,n.compare)(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role,avatar:t.avatar}:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role,e.avatar=t.avatar),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role,e.user.avatar=t.avatar),e),async signIn({user:e,account:t,profile:r}){if(t?.provider==="google")try{await o.z.user.findUnique({where:{email:e.email}})||await o.z.user.create({data:{email:e.email,name:e.name,avatar:e.image,role:l.UserRole.AGENT}})}catch(e){return console.error("Error creating user:",e),!1}return!0}}}},65972:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var s=r(96330);let a=globalThis.prisma??new s.PrismaClient({log:["query"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[5363,3186,7304,4133],()=>r(13414));module.exports=s})();