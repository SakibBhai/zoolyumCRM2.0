(()=>{var e={};e.id=8557,e.ids=[8557],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},11723:e=>{"use strict";e.exports=require("querystring")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},85928:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>E,routeModule:()=>A,serverHooks:()=>T,workAsyncStorage:()=>O,workUnitAsyncStorage:()=>B});var a={};r.r(a),r.d(a,{GET:()=>y,POST:()=>f});var s=r(44932),i=r(41913),n=r(96656),o=r(77949),l=r(86745),d=r(26718),u=r(96330),c=r(84133),p=r(8201);let g=new u.PrismaClient,m=c.Ik({widgetType:c.k5(["stat_card","chart_line","chart_bar","chart_pie","chart_area","table_data","progress_bar","metric_comparison","timeline","heatmap","gauge","funnel","activity_feed","kpi_grid","trend_indicator"]),dataSource:c.k5(["revenues","expenses","projects","tasks","clients","team","budgets","time_entries","custom_query"]),dateRange:c.k5(["7d","30d","90d","6m","1y","custom"]).default("30d"),dateFrom:c.Yj().datetime().optional(),dateTo:c.Yj().datetime().optional(),filters:c.Ik({clientIds:c.YO(c.Yj()).optional(),projectIds:c.YO(c.Yj()).optional(),userIds:c.YO(c.Yj()).optional(),categories:c.YO(c.Yj()).optional(),statuses:c.YO(c.Yj()).optional(),priorities:c.YO(c.Yj()).optional()}).optional(),aggregation:c.k5(["sum","avg","count","min","max"]).default("sum"),groupBy:c.k5(["day","week","month","quarter","year","category","status","priority","user","client","project"]).optional(),limit:c.ai().min(1).max(100).default(10),sortBy:c.Yj().optional(),sortOrder:c.k5(["asc","desc"]).default("desc"),customQuery:c.Ik({table:c.Yj(),fields:c.YO(c.Yj()),conditions:c.g1(c.bz())}).optional()});async function y(e){try{let t,r;let a=await (0,l.getServerSession)(d.Nh);if(!a?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:s}=new URL(e.url),i=s.get("widgetType"),n=s.get("dataSource"),u=s.get("dateRange")||"30d",c=s.get("dateFrom"),p=s.get("dateTo"),g=s.get("filters"),y=s.get("aggregation")||"sum",f=s.get("groupBy"),F=parseInt(s.get("limit")||"10"),_=s.get("sortBy"),A=s.get("sortOrder")||"desc",O=s.get("customQuery");if(!i||!n)return o.NextResponse.json({error:"Widget type and data source are required"},{status:400});let B=m.parse({widgetType:i,dataSource:n,dateRange:u,dateFrom:c,dateTo:p,filters:g?JSON.parse(g):void 0,aggregation:y,groupBy:f,limit:F,sortBy:_,sortOrder:A,customQuery:O?JSON.parse(O):void 0}),T=new Date;if("custom"===B.dateRange&&B.dateFrom&&B.dateTo)t=new Date(B.dateFrom),T=new Date(B.dateTo);else{let e={"7d":7,"30d":30,"90d":90,"6m":180,"1y":365}[B.dateRange]||30;(t=new Date).setDate(t.getDate()-e)}switch(B.dataSource){case"revenues":r=await w(B,t,T);break;case"expenses":r=await h(B,t,T);break;case"projects":r=await v(B,t,T);break;case"tasks":r=await j(B,t,T);break;case"clients":r=await b(B,t,T);break;case"team":r=await I(B,t,T);break;case"budgets":r=await k(B,t,T);break;case"time_entries":r=await x(B,t,T);break;case"custom_query":if(!B.customQuery)return o.NextResponse.json({error:"Custom query parameters required"},{status:400});r=await S(B,t,T);break;default:return o.NextResponse.json({error:"Invalid data source"},{status:400})}return o.NextResponse.json({widgetType:B.widgetType,dataSource:B.dataSource,dateRange:{from:t.toISOString(),to:T.toISOString(),period:B.dateRange},filters:B.filters,generatedAt:new Date().toISOString(),data:r})}catch(e){if(e instanceof p.G)return o.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error generating widget:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function f(e){try{let t=await (0,l.getServerSession)(d.Nh);if(!t?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json(),a=c.Ik({name:c.Yj().min(1).max(100),description:c.Yj().max(500).optional(),widgetType:c.Yj(),dataSource:c.Yj(),configuration:c.g1(c.bz()),isPublic:c.zM().default(!1),dashboardId:c.Yj().optional()}).parse(r),s={id:`widget_${Date.now()}`,name:a.name,description:a.description,widgetType:a.widgetType,dataSource:a.dataSource,configuration:a.configuration,isPublic:a.isPublic,dashboardId:a.dashboardId,createdBy:t.user.id,createdAt:new Date().toISOString()};return o.NextResponse.json(s,{status:201})}catch(e){if(e instanceof p.G)return o.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error saving widget:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function w(e,t,r){let a={date:{gte:t,lte:r}};e.filters?.clientIds?.length&&(a.clientId={in:e.filters.clientIds}),e.filters?.projectIds?.length&&(a.projectId={in:e.filters.projectIds}),e.filters?.statuses?.length&&(a.status={in:e.filters.statuses});let s=await g.revenue.findMany({where:a,include:{client:{select:{id:!0,name:!0}},project:{select:{id:!0,name:!0}}},orderBy:e.sortBy?{[e.sortBy]:e.sortOrder}:{date:"desc"},take:e.limit});return F(e.widgetType,s,e,{valueField:e=>e.amount+e.taxAmount,labelField:e=>e.client?.name||"Unknown Client",dateField:"date",categoryField:"category"})}async function h(e,t,r){let a={date:{gte:t,lte:r}};e.filters?.userIds?.length&&(a.userId={in:e.filters.userIds}),e.filters?.categories?.length&&(a.category={in:e.filters.categories}),e.filters?.statuses?.length&&(a.status={in:e.filters.statuses});let s=await g.expense.findMany({where:a,include:{user:{select:{id:!0,name:!0}},project:{select:{id:!0,name:!0}},client:{select:{id:!0,name:!0}}},orderBy:e.sortBy?{[e.sortBy]:e.sortOrder}:{date:"desc"},take:e.limit});return F(e.widgetType,s,e,{valueField:e=>e.amount+e.taxAmount,labelField:e=>e.user?.name||"Unknown User",dateField:"date",categoryField:"category"})}async function v(e,t,r){let a={createdAt:{gte:t,lte:r}};e.filters?.clientIds?.length&&(a.clientId={in:e.filters.clientIds}),e.filters?.statuses?.length&&(a.status={in:e.filters.statuses});let s=await g.project.findMany({where:a,include:{client:{select:{id:!0,name:!0}},_count:{select:{tasks:!0}}},orderBy:e.sortBy?{[e.sortBy]:e.sortOrder}:{createdAt:"desc"},take:e.limit});return F(e.widgetType,s,e,{valueField:e=>e._count.tasks,labelField:e=>e.name,dateField:"createdAt",categoryField:"status"})}async function j(e,t,r){let a={createdAt:{gte:t,lte:r}};e.filters?.userIds?.length&&(a.assigneeId={in:e.filters.userIds}),e.filters?.projectIds?.length&&(a.projectId={in:e.filters.projectIds}),e.filters?.statuses?.length&&(a.status={in:e.filters.statuses}),e.filters?.priorities?.length&&(a.priority={in:e.filters.priorities});let s=await g.task.findMany({where:a,include:{assignee:{select:{id:!0,name:!0}},project:{select:{id:!0,name:!0}},timeEntries:{select:{hours:!0}}},orderBy:e.sortBy?{[e.sortBy]:e.sortOrder}:{createdAt:"desc"},take:e.limit});return F(e.widgetType,s,e,{valueField:e=>e.timeEntries.reduce((e,t)=>e+t.hours,0),labelField:e=>e.title,dateField:"createdAt",categoryField:"status"})}async function b(e,t,r){let a=await g.client.findMany({where:{createdAt:{gte:t,lte:r},...e.filters?.statuses?.length&&{status:{in:e.filters.statuses}}},include:{_count:{select:{projects:!0,revenues:{where:{date:{gte:t,lte:r}}}}}},orderBy:e.sortBy?{[e.sortBy]:e.sortOrder}:{createdAt:"desc"},take:e.limit});return F(e.widgetType,a,e,{valueField:e=>e._count.projects,labelField:e=>e.name,dateField:"createdAt",categoryField:"status"})}async function I(e,t,r){let a=await g.user.findMany({where:{role:{not:"CLIENT"},isActive:!0,...e.filters?.userIds?.length&&{id:{in:e.filters.userIds}}},include:{_count:{select:{assignedTasks:{where:{createdAt:{gte:t,lte:r}}},timeEntries:{where:{date:{gte:t,lte:r}}}}},timeEntries:{where:{date:{gte:t,lte:r}},select:{hours:!0}}},orderBy:e.sortBy?{[e.sortBy]:e.sortOrder}:{name:"asc"},take:e.limit});return F(e.widgetType,a,e,{valueField:e=>e.timeEntries.reduce((e,t)=>e+t.hours,0),labelField:e=>e.name,dateField:"createdAt",categoryField:"role"})}async function k(e,t,r){let a=await g.budget.findMany({where:{OR:[{startDate:{lte:r},endDate:{gte:t}}],...e.filters?.clientIds?.length&&{clientId:{in:e.filters.clientIds}},...e.filters?.projectIds?.length&&{projectId:{in:e.filters.projectIds}}},include:{project:{select:{id:!0,name:!0}},client:{select:{id:!0,name:!0}}},orderBy:e.sortBy?{[e.sortBy]:e.sortOrder}:{createdAt:"desc"},take:e.limit}),s=await Promise.all(a.map(async e=>{let t=await g.expense.aggregate({where:{date:{gte:e.startDate,lte:e.endDate},...e.projectId&&{projectId:e.projectId},...e.clientId&&{clientId:e.clientId}},_sum:{amount:!0,taxAmount:!0}}),r=(t._sum.amount||0)+(t._sum.taxAmount||0),a=e.totalAmount>0?r/e.totalAmount*100:0;return{...e,utilization:a,spent:r}}));return F(e.widgetType,s,e,{valueField:e=>e.utilization,labelField:e=>e.name,dateField:"createdAt",categoryField:"status"})}async function x(e,t,r){let a=await g.timeEntry.findMany({where:{date:{gte:t,lte:r},...e.filters?.userIds?.length&&{userId:{in:e.filters.userIds}},...e.filters?.projectIds?.length&&{task:{projectId:{in:e.filters.projectIds}}}},include:{user:{select:{id:!0,name:!0}},task:{select:{id:!0,title:!0,project:{select:{id:!0,name:!0}}}}},orderBy:e.sortBy?{[e.sortBy]:e.sortOrder}:{date:"desc"},take:e.limit});return F(e.widgetType,a,e,{valueField:e=>e.hours,labelField:e=>e.user?.name||"Unknown User",dateField:"date",categoryField:"task.project.name"})}async function S(e,t,r){return{message:"Custom widget generation is not fully implemented in this demo",query:e.customQuery,data:[]}}function F(e,t,r,a){let{valueField:s,labelField:i,dateField:n,categoryField:o}=a;switch(e){case"stat_card":let l=t.reduce((e,t)=>e+("function"==typeof s?s(t):t[s]||0),0),d=t.length>0?l/t.length:0,u=t.length;return{value:"avg"===r.aggregation?d:"count"===r.aggregation?u:l,label:`Total ${r.dataSource}`,change:0,trend:"up"};case"chart_line":case"chart_area":var c;let p=(c=r.groupBy||"day",Object.values(t.reduce((e,t)=>{let r;let a=new Date(t[n]);switch(c){case"day":default:r=a.toISOString().split("T")[0];break;case"week":let i=new Date(a);i.setDate(a.getDate()-a.getDay()),r=i.toISOString().split("T")[0];break;case"month":r=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`;break;case"quarter":let o=Math.floor(a.getMonth()/3)+1;r=`${a.getFullYear()}-Q${o}`;break;case"year":r=String(a.getFullYear())}e[r]||(e[r]={period:r,value:0,count:0});let l="function"==typeof s?s(t):t[s]||0;return e[r].value+=l,e[r].count++,e},{})).sort((e,t)=>e.period.localeCompare(t.period)));return{labels:p.map(e=>e.period),datasets:[{label:r.dataSource,data:p.map(e=>e.value)}]};case"chart_bar":let g=_(t,r.groupBy||o,s);return{labels:Object.keys(g),datasets:[{label:r.dataSource,data:Object.values(g)}]};case"chart_pie":let m=_(t,r.groupBy||o,s);return{labels:Object.keys(m),data:Object.values(m)};case"table_data":return{columns:[{key:"label",title:"Name"},{key:"value",title:"Value"},{key:"category",title:"Category"}],rows:t.slice(0,r.limit).map(e=>({label:"function"==typeof i?i(e):e[i],value:"function"==typeof s?s(e):e[s],category:"function"==typeof o?o(e):e[o]}))};case"progress_bar":let y=t.reduce((e,t)=>e+("function"==typeof s?s(t):t[s]||0),0),f=Math.max(...t.map(e=>"function"==typeof s?s(e):e[s]||0));return{value:y,max:f,percentage:f>0?y/f*100:0,label:`${r.dataSource} Progress`};case"metric_comparison":let w=t.reduce((e,t)=>e+("function"==typeof s?s(t):t[s]||0),0);return{current:w,previous:.9*w,change:10,trend:"up"};case"activity_feed":return{activities:t.slice(0,r.limit).map(e=>({id:e.id,title:"function"==typeof i?i(e):e[i],description:`${r.dataSource} activity`,timestamp:e[n],type:r.dataSource}))};case"kpi_grid":return{kpis:[{label:"Total",value:t.reduce((e,t)=>e+("function"==typeof s?s(t):t[s]||0),0),change:5.2,trend:"up"},{label:"Average",value:t.length>0?t.reduce((e,t)=>e+("function"==typeof s?s(t):t[s]||0),0)/t.length:0,change:-2.1,trend:"down"},{label:"Count",value:t.length,change:8.7,trend:"up"}]};case"trend_indicator":return{value:t.reduce((e,t)=>e+("function"==typeof s?s(t):t[s]||0),0),trend:"up",change:12.5,label:`${r.dataSource} Trend`};case"gauge":let h=t.reduce((e,t)=>e+("function"==typeof s?s(t):t[s]||0),0),v=Math.max(100,1.2*h);return{value:h,min:0,max:v,thresholds:[{value:.3*v,color:"red"},{value:.7*v,color:"yellow"},{value:v,color:"green"}]};default:return{data:t.slice(0,r.limit),total:t.length}}}function _(e,t,r){return e.reduce((e,a)=>{let s="function"==typeof t?t(a):a[t]||"Unknown",i="function"==typeof r?r(a):a[r]||0;return e[s]=(e[s]||0)+i,e},{})}let A=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/reports/widgets/route",pathname:"/api/reports/widgets",filename:"route",bundlePath:"app/api/reports/widgets/route"},resolvedPagePath:"E:\\trae\\izoolyumCRM2.0\\zoolyumCRM2.0\\src\\app\\api\\reports\\widgets\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:O,workUnitAsyncStorage:B,serverHooks:T}=A;function E(){return(0,n.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:B})}},27771:()=>{},87859:()=>{},26718:(e,t,r)=>{"use strict";r.d(t,{Nh:()=>u});var a=r(47033),s=r(58196),i=r(34875),n=r(65972),o=r(50826),l=r(96330);let d="true"===process.env.AUTH_BYPASS_ENABLED,u={adapter:(0,a.y)(n.z),session:{strategy:"jwt"},pages:{signIn:"/auth/signin",signUp:"/auth/signup"},providers:[(0,i.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,s.A)({name:"credentials",credentials:{email:{label:"Email",type:"email",placeholder:"john@example.com"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;if(d){console.warn("\uD83D\uDEA8 AUTH BYPASS MODE ENABLED - DEVELOPMENT ONLY!");let e=await n.z.user.findFirst({where:{role:l.UserRole.ADMIN,isActive:!0},select:{id:!0,email:!0,name:!0,role:!0,avatar:!0}});return e?{id:e.id,email:e.email,name:e.name,role:e.role,avatar:e.avatar}:{id:"bypass-user",email:"bypass@agency.com",name:"Bypass User (DEV)",role:l.UserRole.ADMIN,avatar:null}}let t=await n.z.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,password:!0,role:!0,avatar:!0,isActive:!0}});return t&&t.isActive&&t.password&&await (0,o.compare)(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role,avatar:t.avatar}:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role,e.avatar=t.avatar),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role,e.user.avatar=t.avatar),e),async signIn({user:e,account:t,profile:r}){if(t?.provider==="google")try{await n.z.user.findUnique({where:{email:e.email}})||await n.z.user.create({data:{email:e.email,name:e.name,avatar:e.image,role:l.UserRole.AGENT}})}catch(e){return console.error("Error creating user:",e),!1}return!0}}}},65972:(e,t,r)=>{"use strict";r.d(t,{z:()=>s});var a=r(96330);let s=globalThis.prisma??new a.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[5363,3186,7304,4133],()=>r(85928));module.exports=a})();