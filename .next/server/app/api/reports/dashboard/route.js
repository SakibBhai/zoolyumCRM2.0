(()=>{var e={};e.id=2086,e.ids=[2086],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},11723:e=>{"use strict";e.exports=require("querystring")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},28094:(e,t,a)=>{"use strict";a.r(t),a.d(t,{patchFetch:()=>P,routeModule:()=>E,serverHooks:()=>C,workAsyncStorage:()=>T,workUnitAsyncStorage:()=>R});var r={};a.r(r),a.d(r,{GET:()=>w});var s=a(44932),n=a(41913),i=a(96656),o=a(77949),u=a(86745),c=a(26718),l=a(96330),d=a(84133),m=a(8201);let p=new l.PrismaClient,g=d.Ik({dateRange:d.k5(["7d","30d","90d","1y","custom"]).default("30d"),dateFrom:d.Yj().datetime().optional(),dateTo:d.Yj().datetime().optional(),widgets:d.YO(d.k5(["overview_stats","revenue_chart","expense_chart","project_status","team_performance","client_activity","task_completion","budget_utilization","recent_activities","top_clients","upcoming_deadlines","financial_summary"])).default(["overview_stats","revenue_chart","expense_chart","project_status","recent_activities"]),userId:d.Yj().optional(),clientId:d.Yj().optional(),projectId:d.Yj().optional()});async function w(e){try{let t;let a=await (0,u.getServerSession)(c.Nh);if(!a?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),s=r.get("dateRange")||"30d",n=r.get("dateFrom"),i=r.get("dateTo"),l=r.get("widgets")?.split(",")||["overview_stats","revenue_chart","expense_chart","project_status","recent_activities"],d=r.get("userId"),m=r.get("clientId"),p=r.get("projectId"),w=g.parse({dateRange:s,dateFrom:n,dateTo:i,widgets:l,userId:d,clientId:m,projectId:p}),E=new Date;if("custom"===w.dateRange&&w.dateFrom&&w.dateTo)t=new Date(w.dateFrom),E=new Date(w.dateTo);else{let e={"7d":7,"30d":30,"90d":90,"1y":365}[w.dateRange]||30;(t=new Date).setDate(t.getDate()-e)}let T={dateRange:{from:t.toISOString(),to:E.toISOString(),period:w.dateRange},widgets:{}},R={createdAt:{gte:t,lte:E}};for(let e of(w.userId&&(R.userId=w.userId),w.clientId&&(R.clientId=w.clientId),w.projectId&&(R.projectId=w.projectId),w.widgets))switch(e){case"overview_stats":T.widgets.overview_stats=await y(R,t,E);break;case"revenue_chart":T.widgets.revenue_chart=await _(R,t,E);break;case"expense_chart":T.widgets.expense_chart=await v(R,t,E);break;case"project_status":T.widgets.project_status=await x(R);break;case"team_performance":T.widgets.team_performance=await h(R,t,E);break;case"client_activity":T.widgets.client_activity=await A(R,t,E);break;case"task_completion":T.widgets.task_completion=await j(R,t,E);break;case"budget_utilization":T.widgets.budget_utilization=await f(R,t,E);break;case"recent_activities":T.widgets.recent_activities=await k(R);break;case"top_clients":T.widgets.top_clients=await D(R,t,E);break;case"upcoming_deadlines":T.widgets.upcoming_deadlines=await b();break;case"financial_summary":T.widgets.financial_summary=await I(R,t,E)}return o.NextResponse.json(T)}catch(e){if(e instanceof m.G)return o.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error generating dashboard:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function y(e,t,a){let[r,s,n,i,o]=await Promise.all([p.client.count({where:{...e}}),p.project.count({where:e}),p.task.count({where:e}),p.revenue.aggregate({where:{date:{gte:t,lte:a},status:"RECEIVED"},_sum:{amount:!0,taxAmount:!0}}),p.expense.aggregate({where:{date:{gte:t,lte:a},status:"APPROVED"},_sum:{amount:!0,taxAmount:!0}})]),u=(i._sum.amount||0)+(i._sum.taxAmount||0),c=(o._sum.amount||0)+(o._sum.taxAmount||0),l=u-c;return{clients:{total:r,label:"Active Clients"},projects:{total:s,label:"Total Projects"},tasks:{total:n,label:"Total Tasks"},revenue:{total:u,label:"Total Revenue",currency:"USD"},expenses:{total:c,label:"Total Expenses",currency:"USD"},profit:{total:l,margin:u>0?l/u*100:0,label:"Net Profit",currency:"USD"}}}async function _(e,t,a){let r=await p.revenue.findMany({where:{date:{gte:t,lte:a},status:"RECEIVED"},select:{amount:!0,taxAmount:!0,date:!0,category:!0},orderBy:{date:"asc"}});return{data:Object.entries(r.reduce((e,t)=>{let a=t.date.toISOString().split("T")[0];return e[a]||(e[a]=0),e[a]+=t.amount+t.taxAmount,e},{})).map(([e,t])=>({date:e,amount:t})).sort((e,t)=>e.date.localeCompare(t.date)),total:r.reduce((e,t)=>e+t.amount+t.taxAmount,0),count:r.length}}async function v(e,t,a){let r=await p.expense.findMany({where:{date:{gte:t,lte:a}},select:{amount:!0,taxAmount:!0,date:!0,category:!0,status:!0},orderBy:{date:"asc"}});return{data:Object.entries(r.reduce((e,t)=>{let a=t.date.toISOString().split("T")[0];return e[a]||(e[a]=0),e[a]+=t.amount+t.taxAmount,e},{})).map(([e,t])=>({date:e,amount:t})).sort((e,t)=>e.date.localeCompare(t.date)),categoryBreakdown:r.reduce((e,t)=>(e[t.category]||(e[t.category]=0),e[t.category]+=t.amount+t.taxAmount,e),{}),total:r.reduce((e,t)=>e+t.amount+t.taxAmount,0),count:r.length}}async function x(e){let t=await p.project.groupBy({by:["status"],_count:!0,where:e});return{data:t.map(e=>({status:e.status,count:e._count})),total:t.reduce((e,t)=>e+t._count,0)}}async function h(e,t,a){return{data:(await p.user.findMany({where:{role:{not:"CLIENT"},isActive:!0},select:{id:!0,name:!0,email:!0,_count:{select:{assignedTasks:{where:{createdAt:{gte:t,lte:a}}},createdTasks:{where:{createdAt:{gte:t,lte:a}}}}}},take:10})).map(e=>({user:{id:e.id,name:e.name,email:e.email},assignedTasks:e._count.assignedTasks,createdTasks:e._count.createdTasks,totalTasks:e._count.assignedTasks+e._count.createdTasks}))}}async function A(e,t,a){return{data:(await p.client.findMany({where:{},select:{id:!0,name:!0,company:!0,_count:{select:{projects:{where:{createdAt:{gte:t,lte:a}}},revenues:{where:{date:{gte:t,lte:a}}}}}},orderBy:{projects:{_count:"desc"}},take:10})).map(e=>({client:{id:e.id,name:e.name,company:e.company},projectCount:e._count.projects,revenueCount:e._count.revenues}))}}async function j(e,t,a){let r=await p.task.groupBy({by:["status"],_count:!0,where:{createdAt:{gte:t,lte:a}}}),s=r.map(e=>({status:e.status,count:e._count})),n=r.reduce((e,t)=>e+t._count,0),i=r.find(e=>"DONE"===e.status)?._count||0;return{data:s,total:n,completed:i,completionRate:n>0?i/n*100:0}}async function f(e,t,a){let r=await p.budget.findMany({where:{OR:[{startDate:{lte:a},endDate:{gte:t}}]},include:{project:{select:{id:!0,name:!0}},client:{select:{id:!0,name:!0}}},take:10});return{data:await Promise.all(r.map(async e=>{let t=await p.expense.aggregate({where:{date:{gte:e.startDate,lte:e.endDate},...e.projectId&&{projectId:e.projectId},...e.clientId&&{clientId:e.clientId}},_sum:{amount:!0,taxAmount:!0}}),a=(t._sum.amount||0)+(t._sum.taxAmount||0),r=e.totalAmount>0?a/e.totalAmount*100:0;return{budget:{id:e.id,name:e.name,totalAmount:e.totalAmount},project:e.project,client:e.client,spent:a,remaining:e.totalAmount-a,utilization:r,isOverBudget:a>e.totalAmount}}))}}async function k(e){let[t,a,r]=await Promise.all([p.project.findMany({orderBy:{createdAt:"desc"},take:5,select:{id:!0,name:!0,createdAt:!0,client:{select:{name:!0}}}}),p.task.findMany({orderBy:{updatedAt:"desc"},take:5,select:{id:!0,title:!0,status:!0,updatedAt:!0,project:{select:{name:!0}}}}),p.expense.findMany({orderBy:{createdAt:"desc"},take:5,select:{id:!0,description:!0,amount:!0,createdAt:!0,user:{select:{name:!0}}}})]);return{data:[...t.map(e=>({type:"project",id:e.id,title:`New project: ${e.name}`,subtitle:`Client: ${e.client?.name}`,timestamp:e.createdAt})),...a.map(e=>({type:"task",id:e.id,title:`Task ${e.status.toLowerCase()}: ${e.title}`,subtitle:`Project: ${e.project?.name}`,timestamp:e.updatedAt})),...r.map(e=>({type:"expense",id:e.id,title:`New expense: ${e.description}`,subtitle:`$${e.amount} by ${e.user?.name}`,timestamp:e.createdAt}))].sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime()).slice(0,10)}}async function D(e,t,a){return{data:(await p.client.findMany({where:{},select:{id:!0,name:!0,company:!0,revenues:{where:{date:{gte:t,lte:a},status:"RECEIVED"},select:{amount:!0,taxAmount:!0}},_count:{select:{projects:!0}}}})).map(e=>{let t=e.revenues.reduce((e,t)=>e+t.amount+t.taxAmount,0);return{client:{id:e.id,name:e.name,company:e.company},totalRevenue:t,projectCount:e._count.projects,revenueCount:e.revenues.length}}).filter(e=>e.totalRevenue>0).sort((e,t)=>t.totalRevenue-e.totalRevenue).slice(0,10)}}async function b(){let e=new Date,t=new Date;t.setDate(e.getDate()+7);let[a,r]=await Promise.all([p.task.findMany({where:{dueDate:{gte:e,lte:t},status:{not:"DONE"}},select:{id:!0,title:!0,dueDate:!0,priority:!0,project:{select:{name:!0}},assignee:{select:{name:!0}}},orderBy:{dueDate:"asc"},take:10}),p.project.findMany({where:{endDate:{gte:e,lte:t},status:{not:"COMPLETED"}},select:{id:!0,name:!0,endDate:!0,status:!0,client:{select:{name:!0}}},orderBy:{endDate:"asc"},take:5})]);return{data:[...a.map(e=>({type:"task",id:e.id,title:e.title,subtitle:`Project: ${e.project?.name} | Assigned to: ${e.assignee?.name}`,dueDate:e.dueDate,priority:e.priority})),...r.map(e=>({type:"project",id:e.id,title:e.name,subtitle:`Client: ${e.client?.name}`,dueDate:e.endDate,priority:"MEDIUM"}))].sort((e,t)=>new Date(e.dueDate).getTime()-new Date(t.dueDate).getTime())}}async function I(e,t,a){let[r,s,n]=await Promise.all([p.revenue.aggregate({where:{date:{gte:t,lte:a}},_sum:{amount:!0,taxAmount:!0},_count:!0}),p.expense.aggregate({where:{date:{gte:t,lte:a}},_sum:{amount:!0,taxAmount:!0},_count:!0}),p.budget.aggregate({where:{startDate:{lte:a},endDate:{gte:t}},_sum:{totalAmount:!0},_count:!0})]),i=(r._sum.amount||0)+(r._sum.taxAmount||0),o=(s._sum.amount||0)+(s._sum.taxAmount||0),u=n._sum.totalAmount||0,c=i-o;return{revenue:{total:i,count:r._count},expenses:{total:o,count:s._count},budget:{total:u,count:n._count,utilization:u>0?o/u*100:0},profit:{total:c,margin:i>0?c/i*100:0}}}let E=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/reports/dashboard/route",pathname:"/api/reports/dashboard",filename:"route",bundlePath:"app/api/reports/dashboard/route"},resolvedPagePath:"E:\\trae\\izoolyumCRM2.0\\zoolyumCRM2.0\\src\\app\\api\\reports\\dashboard\\route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:T,workUnitAsyncStorage:R,serverHooks:C}=E;function P(){return(0,i.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:R})}},27771:()=>{},87859:()=>{},26718:(e,t,a)=>{"use strict";a.d(t,{Nh:()=>l});var r=a(47033),s=a(58196),n=a(34875),i=a(65972),o=a(50826),u=a(96330);let c="true"===process.env.AUTH_BYPASS_ENABLED,l={adapter:(0,r.y)(i.z),session:{strategy:"jwt"},pages:{signIn:"/auth/signin",signUp:"/auth/signup"},providers:[(0,n.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,s.A)({name:"credentials",credentials:{email:{label:"Email",type:"email",placeholder:"john@example.com"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;if(c){console.warn("\uD83D\uDEA8 AUTH BYPASS MODE ENABLED - DEVELOPMENT ONLY!");let e=await i.z.user.findFirst({where:{role:u.UserRole.ADMIN,isActive:!0},select:{id:!0,email:!0,name:!0,role:!0,avatar:!0}});return e?{id:e.id,email:e.email,name:e.name,role:e.role,avatar:e.avatar}:{id:"bypass-user",email:"bypass@agency.com",name:"Bypass User (DEV)",role:u.UserRole.ADMIN,avatar:null}}let t=await i.z.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,password:!0,role:!0,avatar:!0,isActive:!0}});return t&&t.isActive&&t.password&&await (0,o.compare)(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role,avatar:t.avatar}:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role,e.avatar=t.avatar),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role,e.user.avatar=t.avatar),e),async signIn({user:e,account:t,profile:a}){if(t?.provider==="google")try{await i.z.user.findUnique({where:{email:e.email}})||await i.z.user.create({data:{email:e.email,name:e.name,avatar:e.image,role:u.UserRole.AGENT}})}catch(e){return console.error("Error creating user:",e),!1}return!0}}}},65972:(e,t,a)=>{"use strict";a.d(t,{z:()=>s});var r=a(96330);let s=globalThis.prisma??new r.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[5363,3186,7304,4133],()=>a(28094));module.exports=r})();