(()=>{var e={};e.id=4602,e.ids=[4602],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},11723:e=>{"use strict";e.exports=require("querystring")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},38807:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>_,routeModule:()=>D,serverHooks:()=>N,workAsyncStorage:()=>R,workUnitAsyncStorage:()=>S});var a={};r.r(a),r.d(a,{GET:()=>y,POST:()=>f});var s=r(44932),n=r(41913),i=r(96656),o=r(77949),l=r(86745),u=r(26718),c=r(96330),d=r(84133),m=r(8201);let p=new c.PrismaClient,g=d.Ik({reportType:d.k5(["revenue_analysis","expense_analysis","project_performance","team_productivity","client_profitability","budget_variance","time_tracking","task_completion_rate","financial_trends","resource_utilization","custom_query"]),dateRange:d.k5(["7d","30d","90d","6m","1y","custom"]).default("30d"),dateFrom:d.Yj().datetime().optional(),dateTo:d.Yj().datetime().optional(),groupBy:d.k5(["day","week","month","quarter","year"]).default("day"),filters:d.Ik({clientIds:d.YO(d.Yj()).optional(),projectIds:d.YO(d.Yj()).optional(),userIds:d.YO(d.Yj()).optional(),categories:d.YO(d.Yj()).optional(),statuses:d.YO(d.Yj()).optional(),priorities:d.YO(d.Yj()).optional()}).optional(),metrics:d.YO(d.Yj()).optional(),customQuery:d.Ik({table:d.Yj(),fields:d.YO(d.Yj()),conditions:d.g1(d.bz()),aggregations:d.YO(d.Ik({field:d.Yj(),operation:d.k5(["sum","avg","count","min","max"]),alias:d.Yj().optional()})).optional()}).optional()});async function y(e){try{let t,r;let a=await (0,l.getServerSession)(u.Nh);if(!a?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:s}=new URL(e.url),n=s.get("reportType"),i=s.get("dateRange")||"30d",c=s.get("dateFrom"),d=s.get("dateTo"),m=s.get("groupBy")||"day",p=s.get("filters"),y=s.get("metrics"),f=s.get("customQuery");if(!n)return o.NextResponse.json({error:"Report type is required"},{status:400});let O=g.parse({reportType:n,dateRange:i,dateFrom:c,dateTo:d,groupBy:m,filters:p?JSON.parse(p):void 0,metrics:y?JSON.parse(y):void 0,customQuery:f?JSON.parse(f):void 0}),D=new Date;if("custom"===O.dateRange&&O.dateFrom&&O.dateTo)t=new Date(O.dateFrom),D=new Date(O.dateTo);else{let e={"7d":7,"30d":30,"90d":90,"6m":180,"1y":365,custom:30}[O.dateRange]||30;(t=new Date).setDate(t.getDate()-e)}switch(O.reportType){case"revenue_analysis":r=await h(O,t,D);break;case"expense_analysis":r=await w(O,t,D);break;case"project_performance":r=await v(O,t,D);break;case"team_productivity":r=await j(O,t,D);break;case"client_profitability":r=await k(O,t,D);break;case"budget_variance":r=await x(O,t,D);break;case"time_tracking":r=await I(O,t,D);break;case"task_completion_rate":r=await b(O,t,D);break;case"financial_trends":r=await A(O,t,D);break;case"resource_utilization":r=await T(O,t,D);break;case"custom_query":if(!O.customQuery)return o.NextResponse.json({error:"Custom query parameters required"},{status:400});r=await E(O.customQuery,t,D);break;default:return o.NextResponse.json({error:"Invalid report type"},{status:400})}return o.NextResponse.json({reportType:O.reportType,dateRange:{from:t.toISOString(),to:D.toISOString(),period:O.dateRange},groupBy:O.groupBy,filters:O.filters,generatedAt:new Date().toISOString(),data:r})}catch(e){if(e instanceof m.G)return o.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error generating analytics:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function f(e){try{let t=await (0,l.getServerSession)(u.Nh);if(!t?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json(),a=d.Ik({name:d.Yj().min(1).max(100),description:d.Yj().max(500).optional(),reportType:d.Yj(),parameters:d.g1(d.bz()),isPublic:d.zM().default(!1)}).parse(r),s={id:`report_${Date.now()}`,name:a.name,description:a.description,reportType:a.reportType,parameters:a.parameters,isPublic:a.isPublic,createdBy:t.user.id,createdAt:new Date().toISOString()};return o.NextResponse.json(s,{status:201})}catch(e){if(e instanceof m.G)return o.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error saving analytics report:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function h(e,t,r){let a={date:{gte:t,lte:r}};e.filters?.clientIds?.length&&(a.clientId={in:e.filters.clientIds}),e.filters?.projectIds?.length&&(a.projectId={in:e.filters.projectIds});let s=await p.revenue.findMany({where:a,include:{client:{select:{id:!0,name:!0,company:!0}},project:{select:{id:!0,name:!0}}},orderBy:{date:"asc"}}),n=O(s,e.groupBy,"date"),i=s.reduce((e,t)=>e+t.amount+t.taxAmount,0),o=s.length>0?i/s.length:0,l=s.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+t.amount+t.taxAmount,e),{}),u=s.reduce((e,t)=>(e[t.category]=(e[t.category]||0)+t.amount+t.taxAmount,e),{}),c=Object.entries(s.reduce((e,t)=>{let r=t.client?.name||"Unknown";return e[r]=(e[r]||0)+t.amount+t.taxAmount,e},{})).sort(([,e],[,t])=>t-e).slice(0,10).map(([e,t])=>({name:e,amount:t}));return{timeSeries:n,summary:{total:i,average:o,count:s.length},breakdown:{byStatus:l,byCategory:u},topClients:c}}async function w(e,t,r){let a={date:{gte:t,lte:r}};e.filters?.userIds?.length&&(a.userId={in:e.filters.userIds}),e.filters?.categories?.length&&(a.category={in:e.filters.categories}),e.filters?.statuses?.length&&(a.status={in:e.filters.statuses});let s=await p.expense.findMany({where:a,include:{user:{select:{id:!0,name:!0}},project:{select:{id:!0,name:!0}},client:{select:{id:!0,name:!0}}},orderBy:{date:"asc"}}),n=O(s,e.groupBy,"date"),i=s.reduce((e,t)=>e+t.amount+t.taxAmount,0),o=s.length>0?i/s.length:0,l=s.reduce((e,t)=>(e[t.category]=(e[t.category]||0)+t.amount+t.taxAmount,e),{}),u=s.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+t.amount+t.taxAmount,e),{}),c=Object.entries(s.reduce((e,t)=>{let r=t.user?.name||"Unknown";return e[r]=(e[r]||0)+t.amount+t.taxAmount,e},{})).sort(([,e],[,t])=>t-e).slice(0,10).map(([e,t])=>({name:e,amount:t}));return{timeSeries:n,summary:{total:i,average:o,count:s.length},breakdown:{byCategory:l,byStatus:u},topSpenders:c}}async function v(e,t,r){let a={createdAt:{gte:t,lte:r}};e.filters?.clientIds?.length&&(a.clientId={in:e.filters.clientIds}),e.filters?.statuses?.length&&(a.status={in:e.filters.statuses});let s=await p.project.findMany({where:a,include:{client:{select:{id:!0,name:!0}},tasks:{select:{id:!0,status:!0,priority:!0,timeEntries:{select:{hours:!0}}}},_count:{select:{tasks:!0}}}}),n=s.map(e=>{let t=e.tasks.length,r=e.tasks.filter(e=>"DONE"===e.status).length,a=e.tasks.reduce((e,t)=>e+t.timeEntries.reduce((e,t)=>e+t.hours,0),0),s=e.endDate&&e.startDate?Math.ceil((e.endDate.getTime()-e.startDate.getTime())/864e5):0;return{project:{id:e.id,name:e.name,status:e.status,startDate:e.startDate,endDate:e.endDate},client:e.client,metrics:{totalTasks:t,completedTasks:r,completionRate:t>0?r/t*100:0,totalHours:a,duration:s}}}),i=s.length,o=s.filter(e=>"COMPLETED"===e.status).length,l=n.reduce((e,t)=>e+t.metrics.duration,0)/i;return{projects:n,summary:{totalProjects:i,completedProjects:o,overallCompletionRate:i>0?o/i*100:0,averageProjectDuration:l}}}async function j(e,t,r){let a={createdAt:{gte:t,lte:r}};e.filters?.userIds?.length&&(a.assignedToId={in:e.filters.userIds});let s=await p.task.findMany({where:a,include:{assignee:{select:{id:!0,name:!0,email:!0}},project:{select:{id:!0,name:!0}},timeEntries:{select:{hours:!0,date:!0}}}}),n=s.reduce((e,t)=>{let r=t.assignee?.id||"unassigned";return t.assignee?.name,e[r]||(e[r]={user:t.assignee||{id:"unassigned",name:"Unassigned",email:""},totalTasks:0,completedTasks:0,totalHours:0,tasksByPriority:{LOW:0,MEDIUM:0,HIGH:0,URGENT:0}}),e[r].totalTasks++,"DONE"===t.status&&e[r].completedTasks++,e[r].totalHours+=t.timeEntries.reduce((e,t)=>e+t.hours,0),e[r].tasksByPriority[t.priority]++,e},{});return{teamMetrics:Object.values(n).map(e=>({...e,completionRate:e.totalTasks>0?e.completedTasks/e.totalTasks*100:0,averageHoursPerTask:e.totalTasks>0?e.totalHours/e.totalTasks:0})),summary:{totalTeamMembers:Object.keys(n).length,totalTasks:s.length,totalHours:s.reduce((e,t)=>e+t.timeEntries.reduce((e,t)=>e+t.hours,0),0)}}}async function k(e,t,r){let a=await p.client.findMany({where:{status:"ACTIVE",...e.filters?.clientIds?.length&&{id:{in:e.filters.clientIds}}},include:{revenues:{where:{date:{gte:t,lte:r}},select:{amount:!0,taxAmount:!0}},expenses:{where:{date:{gte:t,lte:r}},select:{amount:!0,taxAmount:!0}},projects:{select:{id:!0,name:!0,status:!0}}}}),s=a.map(e=>{let t=e.revenues.reduce((e,t)=>e+t.amount+t.taxAmount,0),r=e.expenses.reduce((e,t)=>e+t.amount+t.taxAmount,0),a=t-r;return{client:{id:e.id,name:e.name,company:e.company},metrics:{totalRevenue:t,totalExpenses:r,profit:a,profitMargin:t>0?a/t*100:0,projectCount:e.projects.length,revenueCount:e.revenues.length}}}).sort((e,t)=>t.metrics.profit-e.metrics.profit);return{clients:s,summary:{totalClients:a.length,totalRevenue:s.reduce((e,t)=>e+t.metrics.totalRevenue,0),totalExpenses:s.reduce((e,t)=>e+t.metrics.totalExpenses,0),totalProfit:s.reduce((e,t)=>e+t.metrics.profit,0)}}}async function x(e,t,r){let a=await p.budget.findMany({where:{OR:[{startDate:{lte:r},endDate:{gte:t}}]},include:{project:{select:{id:!0,name:!0}},client:{select:{id:!0,name:!0}}}}),s=await Promise.all(a.map(async e=>{let t=await p.expense.aggregate({where:{date:{gte:e.startDate,lte:e.endDate},...e.projectId&&{projectId:e.projectId},...e.clientId&&{clientId:e.clientId}},_sum:{amount:!0,taxAmount:!0}}),r=(t._sum.amount||0)+(t._sum.taxAmount||0),a=e.totalAmount-r,s=e.totalAmount>0?a/e.totalAmount*100:0;return{budget:{id:e.id,name:e.name,totalAmount:e.totalAmount,startDate:e.startDate,endDate:e.endDate},project:e.project,client:e.client,metrics:{budgeted:e.totalAmount,actualSpent:r,variance:a,variancePercentage:s,utilizationRate:e.totalAmount>0?r/e.totalAmount*100:0,isOverBudget:r>e.totalAmount}}}));return{budgets:s,summary:{totalBudgets:a.length,totalBudgeted:s.reduce((e,t)=>e+t.metrics.budgeted,0),totalSpent:s.reduce((e,t)=>e+t.metrics.actualSpent,0),overBudgetCount:s.filter(e=>e.metrics.isOverBudget).length}}}async function I(e,t,r){let a=await p.timeEntry.findMany({where:{date:{gte:t,lte:r},...e.filters?.userIds?.length&&{userId:{in:e.filters.userIds}},...e.filters?.projectIds?.length&&{task:{projectId:{in:e.filters.projectIds}}}},include:{user:{select:{id:!0,name:!0}},task:{select:{id:!0,title:!0,project:{select:{id:!0,name:!0}}}}},orderBy:{date:"asc"}}),s=O(a,e.groupBy,"date"),n=a.reduce((e,t)=>{let r=t.user?.id||"unknown",a=t.user?.name||"Unknown";return e[r]||(e[r]={user:{id:r,name:a},totalHours:0,entries:0}),e[r].totalHours+=t.hours,e[r].entries++,e},{}),i=a.reduce((e,t)=>{let r=t.task?.project?.id||"unknown",a=t.task?.project?.name||"Unknown";return e[r]||(e[r]={project:{id:r,name:a},totalHours:0,entries:0}),e[r].totalHours+=t.hours,e[r].entries++,e},{});return{timeSeries:s,byUser:Object.values(n),byProject:Object.values(i),summary:{totalHours:a.reduce((e,t)=>e+t.hours,0),totalEntries:a.length,averageHoursPerEntry:a.length>0?a.reduce((e,t)=>e+t.hours,0)/a.length:0}}}async function b(e,t,r){let a=await p.task.findMany({where:{createdAt:{gte:t,lte:r},...e.filters?.userIds?.length&&{assignedToId:{in:e.filters.userIds}},...e.filters?.projectIds?.length&&{projectId:{in:e.filters.projectIds}},...e.filters?.priorities?.length&&{priority:{in:e.filters.priorities}}},include:{assignee:{select:{id:!0,name:!0}},project:{select:{id:!0,name:!0}}}}),s=O(a,e.groupBy,"createdAt"),n=a.reduce((e,t)=>(e[t.priority]||(e[t.priority]={total:0,completed:0}),e[t.priority].total++,"DONE"===t.status&&e[t.priority].completed++,e),{}),i=a.reduce((e,t)=>{let r=t.assignee?.id||"unassigned",a=t.assignee?.name||"Unassigned";return e[r]||(e[r]={user:{id:r,name:a},total:0,completed:0}),e[r].total++,"DONE"===t.status&&e[r].completed++,e},{});return{timeSeries:s,byPriority:Object.entries(n).map(([e,t])=>({priority:e,total:t.total,completed:t.completed,completionRate:t.total>0?t.completed/t.total*100:0})),byUser:Object.values(i).map(e=>({...e,completionRate:e.total>0?e.completed/e.total*100:0})),summary:{totalTasks:a.length,completedTasks:a.filter(e=>"DONE"===e.status).length,overallCompletionRate:a.length>0?a.filter(e=>"DONE"===e.status).length/a.length*100:0}}}async function A(e,t,r){let[a,s]=await Promise.all([p.revenue.findMany({where:{date:{gte:t,lte:r}},select:{amount:!0,taxAmount:!0,date:!0,category:!0},orderBy:{date:"asc"}}),p.expense.findMany({where:{date:{gte:t,lte:r}},select:{amount:!0,taxAmount:!0,date:!0,category:!0},orderBy:{date:"asc"}})]),n=O(a,e.groupBy,"date"),i=O(s,e.groupBy,"date"),o=n.map((e,t)=>{let r=i[t]||{period:e.period,value:0};return{period:e.period,revenue:e.value,expenses:r.value,profit:e.value-r.value,profitMargin:e.value>0?(e.value-r.value)/e.value*100:0}});return{revenue:n,expenses:i,profit:o,summary:{totalRevenue:a.reduce((e,t)=>e+t.amount+t.taxAmount,0),totalExpenses:s.reduce((e,t)=>e+t.amount+t.taxAmount,0),netProfit:a.reduce((e,t)=>e+t.amount+t.taxAmount,0)-s.reduce((e,t)=>e+t.amount+t.taxAmount,0)}}}async function T(e,t,r){let a=await p.user.findMany({where:{role:{not:"CLIENT"},isActive:!0,...e.filters?.userIds?.length&&{id:{in:e.filters.userIds}}},include:{timeEntries:{where:{date:{gte:t,lte:r}},select:{hours:!0,date:!0}},assignedTasks:{where:{createdAt:{gte:t,lte:r}},select:{id:!0,status:!0,priority:!0}}}}),s=a.map(e=>{let a=e.timeEntries.reduce((e,t)=>e+t.hours,0),s=8*Math.ceil((r.getTime()-t.getTime())/864e5),n=e.assignedTasks.filter(e=>"DONE"!==e.status).length,i=e.assignedTasks.filter(e=>"DONE"===e.status).length;return{user:{id:e.id,name:e.name,email:e.email,role:e.role},metrics:{totalHours:a,expectedHours:s,utilizationRate:s>0?a/s*100:0,activeTasks:n,completedTasks:i,totalTasks:e.assignedTasks.length}}});return{users:s,summary:{totalUsers:a.length,averageUtilization:s.reduce((e,t)=>e+t.metrics.utilizationRate,0)/a.length,totalHours:s.reduce((e,t)=>e+t.metrics.totalHours,0)}}}async function E(e,t,r){try{if(!["client","project","task","user","revenue","expense","budget","timeEntry"].includes(e.table))throw Error("Invalid table name");return{table:e.table,fields:e.fields,conditions:e.conditions,data:[],message:"Custom query execution is not fully implemented in this demo"}}catch(e){throw Error(`Custom query execution failed: ${e}`)}}function O(e,t,r){return Object.values(e.reduce((e,a)=>{let s;let n=new Date(a[r]);switch(t){case"day":default:s=n.toISOString().split("T")[0];break;case"week":let i=new Date(n);i.setDate(n.getDate()-n.getDay()),s=i.toISOString().split("T")[0];break;case"month":s=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`;break;case"quarter":let o=Math.floor(n.getMonth()/3)+1;s=`${n.getFullYear()}-Q${o}`;break;case"year":s=String(n.getFullYear())}e[s]||(e[s]={period:s,value:0,count:0});let l=0;return l="amount"in a?a.amount+(a.taxAmount||0):"hours"in a?a.hours:1,e[s].value+=l,e[s].count++,e},{})).sort((e,t)=>e.period.localeCompare(t.period))}let D=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/reports/analytics/route",pathname:"/api/reports/analytics",filename:"route",bundlePath:"app/api/reports/analytics/route"},resolvedPagePath:"E:\\trae\\izoolyumCRM2.0\\zoolyumCRM2.0\\src\\app\\api\\reports\\analytics\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:R,workUnitAsyncStorage:S,serverHooks:N}=D;function _(){return(0,i.patchFetch)({workAsyncStorage:R,workUnitAsyncStorage:S})}},27771:()=>{},87859:()=>{},26718:(e,t,r)=>{"use strict";r.d(t,{Nh:()=>c});var a=r(47033),s=r(58196),n=r(34875),i=r(65972),o=r(50826),l=r(96330);let u="true"===process.env.AUTH_BYPASS_ENABLED,c={adapter:(0,a.y)(i.z),session:{strategy:"jwt"},pages:{signIn:"/auth/signin",signUp:"/auth/signup"},providers:[(0,n.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,s.A)({name:"credentials",credentials:{email:{label:"Email",type:"email",placeholder:"john@example.com"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;if(u){console.warn("\uD83D\uDEA8 AUTH BYPASS MODE ENABLED - DEVELOPMENT ONLY!");let e=await i.z.user.findFirst({where:{role:l.UserRole.ADMIN,isActive:!0},select:{id:!0,email:!0,name:!0,role:!0,avatar:!0}});return e?{id:e.id,email:e.email,name:e.name,role:e.role,avatar:e.avatar}:{id:"bypass-user",email:"bypass@agency.com",name:"Bypass User (DEV)",role:l.UserRole.ADMIN,avatar:null}}let t=await i.z.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,password:!0,role:!0,avatar:!0,isActive:!0}});return t&&t.isActive&&t.password&&await (0,o.compare)(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role,avatar:t.avatar}:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role,e.avatar=t.avatar),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role,e.user.avatar=t.avatar),e),async signIn({user:e,account:t,profile:r}){if(t?.provider==="google")try{await i.z.user.findUnique({where:{email:e.email}})||await i.z.user.create({data:{email:e.email,name:e.name,avatar:e.image,role:l.UserRole.AGENT}})}catch(e){return console.error("Error creating user:",e),!1}return!0}}}},65972:(e,t,r)=>{"use strict";r.d(t,{z:()=>s});var a=r(96330);let s=globalThis.prisma??new a.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[5363,3186,7304,4133],()=>r(38807));module.exports=a})();