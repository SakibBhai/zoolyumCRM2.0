(()=>{var e={};e.id=2832,e.ids=[2832],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},11723:e=>{"use strict";e.exports=require("querystring")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},54083:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>q,routeModule:()=>_,serverHooks:()=>O,workAsyncStorage:()=>E,workUnitAsyncStorage:()=>k});var a={};r.r(a),r.d(a,{GET:()=>y});var n=r(44932),o=r(41913),s=r(96656),i=r(77949),u=r(86745),l=r(26718),c=r(96330),d=r(84133),p=r(8201);let m=new c.PrismaClient,g=d.Ik({reportType:d.k5(["expense_summary","budget_utilization","client_spending","project_costs","category_breakdown","monthly_trends","quarterly_analysis","yearly_overview","cost_center_analysis","roi_analysis"]),dateFrom:d.Yj().datetime(),dateTo:d.Yj().datetime(),clientId:d.Yj().optional(),projectId:d.Yj().optional(),userId:d.Yj().optional(),categories:d.YO(d.Yj()).optional(),includeProjections:d.zM().default(!1),groupBy:d.k5(["day","week","month","quarter","year"]).default("month"),currency:d.Yj().default("USD")}).refine(e=>new Date(e.dateTo)>new Date(e.dateFrom),{message:"End date must be after start date",path:["dateTo"]});async function y(e){try{let t=await (0,u.getServerSession)(l.Nh);if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),a=r.get("reportType")||"expense_summary",n=r.get("dateFrom"),o=r.get("dateTo"),s=r.get("clientId"),c=r.get("projectId"),d=r.get("userId"),p=r.get("categories")?.split(",").filter(Boolean),m="true"===r.get("includeProjections"),y=r.get("groupBy")||"month",_=r.get("currency")||"USD";if(!n||!o)return i.NextResponse.json({error:"dateFrom and dateTo parameters are required"},{status:400});let E=g.parse({reportType:a,dateFrom:n,dateTo:o,clientId:s,projectId:c,userId:d,categories:p,includeProjections:m,groupBy:y,currency:_}),k=new Date(E.dateFrom),O=new Date(E.dateTo),q={date:{gte:k,lte:O}};E.clientId&&(q.clientId=E.clientId),E.projectId&&(q.projectId=E.projectId),E.userId&&(q.userId=E.userId),E.categories&&E.categories.length>0&&(q.category={in:E.categories});let T={};switch(E.reportType){case"expense_summary":T=await x(q,E);break;case"budget_utilization":T=await w(q,E);break;case"client_spending":T=await A(q,E);break;case"project_costs":T=await h(q,E);break;case"category_breakdown":T=await j(q,E);break;case"monthly_trends":T=await v(q,E);break;case"quarterly_analysis":T=await f(q,E);break;case"yearly_overview":T=await b(q,E);break;case"cost_center_analysis":T=await I(q,E);break;case"roi_analysis":T=await C(q,E);break;default:return i.NextResponse.json({error:"Invalid report type"},{status:400})}return i.NextResponse.json({reportType:E.reportType,parameters:E,generatedAt:new Date().toISOString(),data:T})}catch(e){if(e instanceof p.G)return i.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error generating financial report:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function x(e,t){let r=await m.expense.findMany({where:e,include:{user:{select:{id:!0,name:!0,email:!0}},project:{select:{id:!0,name:!0}},client:{select:{id:!0,name:!0,company:!0}}},orderBy:{date:"desc"}}),a=r.reduce((e,t)=>e+t.amount+t.taxAmount,0),n=r.length;return{summary:{totalAmount:a,totalExpenses:n,averageExpense:n>0?a/n:0},breakdowns:{byStatus:r.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+t.amount+t.taxAmount,e),{}),byCategory:r.reduce((e,t)=>(e[t.category]=(e[t.category]||0)+t.amount+t.taxAmount,e),{}),byUser:Object.values(r.reduce((e,t)=>{let r=t.user.id;return e[r]||(e[r]={user:t.user,totalAmount:0,expenseCount:0}),e[r].totalAmount+=t.amount+t.taxAmount,e[r].expenseCount+=1,e},{}))},expenses:r.slice(0,50)}}async function w(e,t){let r=await m.budget.findMany({where:{OR:[{startDate:{lte:new Date(t.dateTo)},endDate:{gte:new Date(t.dateFrom)}}],...t.clientId&&{clientId:t.clientId},...t.projectId&&{projectId:t.projectId}},include:{project:{select:{id:!0,name:!0}},client:{select:{id:!0,name:!0,company:!0}}}}),a=await Promise.all(r.map(async t=>{let r={...e,date:{gte:t.startDate,lte:t.endDate}};t.projectId&&(r.projectId=t.projectId),t.clientId&&(r.clientId=t.clientId);let a=await m.expense.findMany({where:r,select:{amount:!0,taxAmount:!0,category:!0}}),n=a.reduce((e,t)=>e+t.amount+t.taxAmount,0),o=t.totalAmount>0?n/t.totalAmount*100:0;return{budget:t,totalSpent:n,remainingAmount:t.totalAmount-n,utilizationPercentage:o,isOverBudget:n>t.totalAmount,expenseCount:a.length}})),n=r.reduce((e,t)=>e+t.totalAmount,0),o=a.reduce((e,t)=>e+t.totalSpent,0);return{summary:{totalBudgets:r.length,totalBudgetAmount:n,totalSpentAmount:o,overallUtilization:n>0?o/n*100:0,overBudgetCount:a.filter(e=>e.isOverBudget).length},budgets:a}}async function A(e,t){let r=(await m.expense.findMany({where:e,include:{client:{select:{id:!0,name:!0,company:!0}},project:{select:{id:!0,name:!0}}}})).reduce((e,t)=>{if(!t.client)return e;let r=t.client.id;return e[r]||(e[r]={client:t.client,totalAmount:0,expenseCount:0,projects:new Set,categories:{}}),e[r].totalAmount+=t.amount+t.taxAmount,e[r].expenseCount+=1,t.project&&e[r].projects.add(t.project.name),e[r].categories[t.category]=(e[r].categories[t.category]||0)+t.amount+t.taxAmount,e},{});Object.values(r).forEach(e=>{e.projects=Array.from(e.projects)});let a=Object.values(r).sort((e,t)=>t.totalAmount-e.totalAmount);return{summary:{totalClients:a.length,totalSpending:a.reduce((e,t)=>e+t.totalAmount,0)},clients:a}}async function h(e,t){let r=Object.values((await m.expense.findMany({where:e,include:{project:{select:{id:!0,name:!0,status:!0,budget:!0,client:{select:{id:!0,name:!0,company:!0}}}}}})).reduce((e,t)=>{if(!t.project)return e;let r=t.project.id;return e[r]||(e[r]={project:t.project,totalCost:0,expenseCount:0,categories:{}}),e[r].totalCost+=t.amount+t.taxAmount,e[r].expenseCount+=1,e[r].categories[t.category]=(e[r].categories[t.category]||0)+t.amount+t.taxAmount,e},{})).sort((e,t)=>t.totalCost-e.totalCost).map(e=>({...e,budgetUtilization:e.project.budget>0?e.totalCost/e.project.budget*100:0,isOverBudget:e.project.budget>0&&e.totalCost>e.project.budget}));return{summary:{totalProjects:r.length,totalCosts:r.reduce((e,t)=>e+t.totalCost,0),overBudgetProjects:r.filter(e=>e.isOverBudget).length},projects:r}}async function j(e,t){let r=(await m.expense.findMany({where:e,select:{amount:!0,taxAmount:!0,category:!0,date:!0}})).reduce((e,t)=>{let r=t.category;return e[r]||(e[r]={category:r,totalAmount:0,expenseCount:0,averageAmount:0}),e[r].totalAmount+=t.amount+t.taxAmount,e[r].expenseCount+=1,e},{});Object.values(r).forEach(e=>{e.averageAmount=e.expenseCount>0?e.totalAmount/e.expenseCount:0});let a=Object.values(r).sort((e,t)=>t.totalAmount-e.totalAmount),n=a.reduce((e,t)=>e+t.totalAmount,0);return a.forEach(e=>{e.percentageOfTotal=n>0?e.totalAmount/n*100:0}),{summary:{totalCategories:a.length,totalAmount:n,topCategory:a[0]?.category||null},categories:a}}async function v(e,t){let r=Object.values((await m.expense.findMany({where:e,select:{amount:!0,taxAmount:!0,date:!0,category:!0},orderBy:{date:"asc"}})).reduce((e,t)=>{let r=t.date.toISOString().substring(0,7);return e[r]||(e[r]={month:r,totalAmount:0,expenseCount:0,categories:{}}),e[r].totalAmount+=t.amount+t.taxAmount,e[r].expenseCount+=1,e[r].categories[t.category]=(e[r].categories[t.category]||0)+t.amount+t.taxAmount,e},{})).sort((e,t)=>e.month.localeCompare(t.month));return r.forEach((e,t)=>{if(t>0){let a=r[t-1];e.growthRate=a.totalAmount>0?(e.totalAmount-a.totalAmount)/a.totalAmount*100:0}else e.growthRate=0}),{summary:{totalMonths:r.length,averageMonthlySpending:r.length>0?r.reduce((e,t)=>e+t.totalAmount,0)/r.length:0,highestMonth:r.reduce((e,t)=>t.totalAmount>(e?.totalAmount||0)?t:e,null),lowestMonth:r.reduce((e,t)=>t.totalAmount<(e?.totalAmount||1/0)?t:e,null)},months:r}}async function f(e,t){return{message:"Quarterly analysis report - implementation pending"}}async function b(e,t){return{message:"Yearly overview report - implementation pending"}}async function I(e,t){return{message:"Cost center analysis report - implementation pending"}}async function C(e,t){return{message:"ROI analysis report - implementation pending"}}let _=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/finance/reports/route",pathname:"/api/finance/reports",filename:"route",bundlePath:"app/api/finance/reports/route"},resolvedPagePath:"E:\\trae\\izoolyumCRM2.0\\zoolyumCRM2.0\\src\\app\\api\\finance\\reports\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:E,workUnitAsyncStorage:k,serverHooks:O}=_;function q(){return(0,s.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:k})}},27771:()=>{},87859:()=>{},26718:(e,t,r)=>{"use strict";r.d(t,{Nh:()=>c});var a=r(47033),n=r(58196),o=r(34875),s=r(65972),i=r(50826),u=r(96330);let l="true"===process.env.AUTH_BYPASS_ENABLED,c={adapter:(0,a.y)(s.z),session:{strategy:"jwt"},pages:{signIn:"/auth/signin",signUp:"/auth/signup"},providers:[(0,o.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,n.A)({name:"credentials",credentials:{email:{label:"Email",type:"email",placeholder:"john@example.com"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;if(l){console.warn("\uD83D\uDEA8 AUTH BYPASS MODE ENABLED - DEVELOPMENT ONLY!");let e=await s.z.user.findFirst({where:{role:u.UserRole.ADMIN,isActive:!0},select:{id:!0,email:!0,name:!0,role:!0,avatar:!0}});return e?{id:e.id,email:e.email,name:e.name,role:e.role,avatar:e.avatar}:{id:"bypass-user",email:"bypass@agency.com",name:"Bypass User (DEV)",role:u.UserRole.ADMIN,avatar:null}}let t=await s.z.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,password:!0,role:!0,avatar:!0,isActive:!0}});return t&&t.isActive&&t.password&&await (0,i.compare)(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role,avatar:t.avatar}:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role,e.avatar=t.avatar),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role,e.user.avatar=t.avatar),e),async signIn({user:e,account:t,profile:r}){if(t?.provider==="google")try{await s.z.user.findUnique({where:{email:e.email}})||await s.z.user.create({data:{email:e.email,name:e.name,avatar:e.image,role:u.UserRole.AGENT}})}catch(e){return console.error("Error creating user:",e),!1}return!0}}}},65972:(e,t,r)=>{"use strict";r.d(t,{z:()=>n});var a=r(96330);let n=globalThis.prisma??new a.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[5363,3186,7304,4133],()=>r(54083));module.exports=a})();