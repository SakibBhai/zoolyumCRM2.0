(()=>{var e={};e.id=1379,e.ids=[1379],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},11723:e=>{"use strict";e.exports=require("querystring")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},8644:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>I,routeModule:()=>E,serverHooks:()=>R,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>y});var a={};r.r(a),r.d(a,{DELETE:()=>j,GET:()=>h,POST:()=>w,PUT:()=>v});var s=r(44932),n=r(41913),o=r(96656),i=r(77949),u=r(86745),l=r(26718),d=r(96330),c=r(84133),p=r(8201);let m=new d.PrismaClient,g=c.Ik({name:c.Yj().min(1,"Budget name is required"),description:c.Yj().optional(),totalAmount:c.ai().min(0,"Total amount must be positive"),period:c.k5(["MONTHLY","QUARTERLY","YEARLY","CUSTOM"]),startDate:c.Yj().datetime(),endDate:c.Yj().datetime(),projectId:c.Yj().optional(),clientId:c.Yj().optional(),categories:c.YO(c.Ik({category:c.k5(["OFFICE_SUPPLIES","TRAVEL","MEALS","SOFTWARE","HARDWARE","MARKETING","UTILITIES","RENT","INSURANCE","PROFESSIONAL_SERVICES","OTHER"]),allocatedAmount:c.ai().min(0,"Allocated amount must be positive"),description:c.Yj().optional()})).optional(),alertThreshold:c.ai().min(0).max(100,"Alert threshold must be between 0 and 100").default(80),isActive:c.zM().default(!0),notes:c.Yj().optional()}).refine(e=>new Date(e.endDate)>new Date(e.startDate),{message:"End date must be after start date",path:["endDate"]}),A=c.Ik({name:c.Yj().min(1,"Budget name is required").optional(),description:c.Yj().optional(),totalAmount:c.ai().min(0,"Total amount must be positive").optional(),period:c.k5(["MONTHLY","QUARTERLY","YEARLY","CUSTOM"]).optional(),startDate:c.Yj().datetime().optional(),endDate:c.Yj().datetime().optional(),projectId:c.Yj().optional(),clientId:c.Yj().optional(),categories:c.YO(c.Ik({category:c.k5(["OFFICE_SUPPLIES","TRAVEL","MEALS","SOFTWARE","HARDWARE","MARKETING","UTILITIES","RENT","INSURANCE","PROFESSIONAL_SERVICES","OTHER"]),allocatedAmount:c.ai().min(0,"Allocated amount must be positive"),description:c.Yj().optional()})).optional(),alertThreshold:c.ai().min(0).max(100,"Alert threshold must be between 0 and 100").optional(),isActive:c.zM().optional(),notes:c.Yj().optional()});async function h(e){try{let t=await (0,u.getServerSession)(l.Nh);if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),a=parseInt(r.get("page")||"1"),s=parseInt(r.get("limit")||"10"),n=r.get("search")||"",o=r.get("period"),d=r.get("projectId"),c=r.get("clientId"),p=r.get("isActive"),g=r.get("dateFrom"),A=r.get("dateTo"),h=r.get("sortBy")||"createdAt",w=r.get("sortOrder")||"desc",v="true"===r.get("includeExpenses"),j=(a-1)*s,E={};n&&(E.OR=[{name:{contains:n,mode:"insensitive"}},{description:{contains:n,mode:"insensitive"}},{notes:{contains:n,mode:"insensitive"}}]),o&&(E.period=o),d&&(E.projectId=d),c&&(E.clientId=c),null!=p&&(E.isActive="true"===p),(g||A)&&(E.AND=[],g&&E.AND.push({OR:[{startDate:{gte:new Date(g)}},{endDate:{gte:new Date(g)}}]}),A&&E.AND.push({startDate:{lte:new Date(A)}}));let[x,y]=await Promise.all([m.budget.findMany({where:E,skip:j,take:s,orderBy:{[h]:w},include:{project:{select:{id:!0,name:!0,status:!0,client:{select:{id:!0,name:!0,company:!0}}}},client:{select:{id:!0,name:!0,company:!0}},creator:{select:{id:!0,name:!0,email:!0,avatarUrl:!0}}}}),m.budget.count({where:E})]),R=x;v&&(R=await Promise.all(x.map(async e=>{let t={date:{gte:e.startDate,lte:e.endDate}};e.projectId&&(t.projectId=e.projectId),e.clientId&&(t.clientId=e.clientId);let r=await m.expense.findMany({where:t,select:{amount:!0,taxAmount:!0,category:!0}}),a=r.reduce((e,t)=>e+t.amount+t.taxAmount,0),s=r.reduce((e,t)=>{let r=t.category;return e[r]||(e[r]=0),e[r]+=t.amount+t.taxAmount,e},{}),n=e.totalAmount>0?a/e.totalAmount*100:0,o=e.totalAmount-a,i=a>e.totalAmount,u=n>=e.alertThreshold;return{...e,utilization:{totalSpent:a,remainingAmount:o,utilizationPercentage:n,isOverBudget:i,isNearThreshold:u,categorySpending:s,expenseCount:r.length}}})));let I=await m.budget.aggregate({where:E,_sum:{totalAmount:!0},_count:{_all:!0}}),f=await m.budget.groupBy({by:["isActive"],where:E,_count:{_all:!0},_sum:{totalAmount:!0}}),N=Math.ceil(y/s);return i.NextResponse.json({budgets:R,pagination:{page:a,limit:s,total:y,totalPages:N,hasNext:a<N,hasPrev:a>1},summary:{totalBudgetAmount:I._sum.totalAmount||0,totalCount:I._count._all,statusBreakdown:f.reduce((e,t)=>(e[t.isActive?"active":"inactive"]={count:t._count._all,amount:t._sum.totalAmount||0},e),{})}})}catch(e){return console.error("Error fetching budgets:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function w(e){try{let t=await (0,u.getServerSession)(l.Nh);if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json(),a=g.parse(r);if(a.projectId){let e=await m.project.findUnique({where:{id:a.projectId},select:{id:!0,clientId:!0}});if(!e)return i.NextResponse.json({error:"Project not found"},{status:404});a.clientId||(a.clientId=e.clientId)}if(a.clientId&&!await m.client.findUnique({where:{id:a.clientId}}))return i.NextResponse.json({error:"Client not found"},{status:404});if(a.categories&&a.categories.length>0){let e=a.categories.reduce((e,t)=>e+t.allocatedAmount,0);if(e>a.totalAmount)return i.NextResponse.json({error:"Total category allocations exceed budget amount",totalAllocated:e,budgetAmount:a.totalAmount},{status:400})}let s=await m.budget.create({data:{...a,startDate:new Date(a.startDate),endDate:new Date(a.endDate),categories:a.categories||[],createdBy:t.user.id},include:{project:{select:{id:!0,name:!0,status:!0,client:{select:{id:!0,name:!0,company:!0}}}},client:{select:{id:!0,name:!0,company:!0}},creator:{select:{id:!0,name:!0,email:!0}}}});return i.NextResponse.json(s,{status:201})}catch(e){if(e instanceof p.G)return i.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error creating budget:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function v(e){try{let t=await (0,u.getServerSession)(l.Nh);if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{ids:r,data:a}=await e.json();if(!Array.isArray(r)||0===r.length)return i.NextResponse.json({error:"Budget IDs array is required"},{status:400});let s=A.parse(a);if((await m.budget.findMany({where:{id:{in:r}},select:{id:!0,name:!0}})).length!==r.length)return i.NextResponse.json({error:"One or more budgets not found"},{status:404});let n={...s,updatedAt:new Date};s.startDate&&(n.startDate=new Date(s.startDate)),s.endDate&&(n.endDate=new Date(s.endDate));let o=await m.budget.updateMany({where:{id:{in:r}},data:n});return i.NextResponse.json({message:`${o.count} budgets updated successfully`,updatedCount:o.count})}catch(e){if(e instanceof p.G)return i.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error bulk updating budgets:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function j(e){try{let t=await (0,u.getServerSession)(l.Nh);if(!t?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{ids:r}=await e.json();if(!Array.isArray(r)||0===r.length)return i.NextResponse.json({error:"Budget IDs array is required"},{status:400});let a=await m.budget.findMany({where:{id:{in:r}},select:{id:!0,name:!0,isActive:!0}});if(a.length!==r.length)return i.NextResponse.json({error:"One or more budgets not found"},{status:404});let s=a.filter(e=>e.isActive);if(s.length>0)return i.NextResponse.json({error:"Cannot delete active budgets. Please deactivate them first.",activeBudgets:s.map(e=>({id:e.id,name:e.name}))},{status:409});let n=await m.budget.deleteMany({where:{id:{in:r}}});return i.NextResponse.json({message:`${n.count} budgets deleted successfully`,deletedCount:n.count})}catch(e){return console.error("Error deleting budgets:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let E=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/finance/budgets/route",pathname:"/api/finance/budgets",filename:"route",bundlePath:"app/api/finance/budgets/route"},resolvedPagePath:"E:\\trae\\izoolyumCRM2.0\\zoolyumCRM2.0\\src\\app\\api\\finance\\budgets\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:x,workUnitAsyncStorage:y,serverHooks:R}=E;function I(){return(0,o.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:y})}},27771:()=>{},87859:()=>{},26718:(e,t,r)=>{"use strict";r.d(t,{Nh:()=>d});var a=r(47033),s=r(58196),n=r(34875),o=r(65972),i=r(50826),u=r(96330);let l="true"===process.env.AUTH_BYPASS_ENABLED,d={adapter:(0,a.y)(o.z),session:{strategy:"jwt"},pages:{signIn:"/auth/signin",signUp:"/auth/signup"},providers:[(0,n.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,s.A)({name:"credentials",credentials:{email:{label:"Email",type:"email",placeholder:"john@example.com"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;if(l){console.warn("\uD83D\uDEA8 AUTH BYPASS MODE ENABLED - DEVELOPMENT ONLY!");let e=await o.z.user.findFirst({where:{role:u.UserRole.ADMIN,isActive:!0},select:{id:!0,email:!0,name:!0,role:!0,avatar:!0}});return e?{id:e.id,email:e.email,name:e.name,role:e.role,avatar:e.avatar}:{id:"bypass-user",email:"bypass@agency.com",name:"Bypass User (DEV)",role:u.UserRole.ADMIN,avatar:null}}let t=await o.z.user.findUnique({where:{email:e.email},select:{id:!0,email:!0,name:!0,password:!0,role:!0,avatar:!0,isActive:!0}});return t&&t.isActive&&t.password&&await (0,i.compare)(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role,avatar:t.avatar}:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role,e.avatar=t.avatar),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role,e.user.avatar=t.avatar),e),async signIn({user:e,account:t,profile:r}){if(t?.provider==="google")try{await o.z.user.findUnique({where:{email:e.email}})||await o.z.user.create({data:{email:e.email,name:e.name,avatar:e.image,role:u.UserRole.AGENT}})}catch(e){return console.error("Error creating user:",e),!1}return!0}}}},65972:(e,t,r)=>{"use strict";r.d(t,{z:()=>s});var a=r(96330);let s=globalThis.prisma??new a.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[5363,3186,7304,4133],()=>r(8644));module.exports=a})();